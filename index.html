<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Lead Portal | StayVCS</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@800;900&family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#020617;--bg2:#0f172a;--bg3:#1e293b;--blue:#3b82f6;--blue-d:#1d4ed8;--cyan:#06b6d4;--green:#10b981;--gold:#c8973a;--red:#ef4444;--yellow:#f59e0b;--muted:#64748b;--text:#f8fafc;--border:rgba(51,65,85,.75);--mono:'JetBrains Mono',monospace;--disp:'Syne',sans-serif;--body:'Manrope',sans-serif}
*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
body{font-family:var(--body);background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(circle at 8% 10%,rgba(30,58,138,.22) 0%,transparent 42%),radial-gradient(circle at 88% 78%,rgba(6,182,212,.06) 0%,transparent 38%)}

/* TOPBAR */
.tb{position:sticky;top:0;z-index:50;background:rgba(2,6,23,.93);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 28px;height:64px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.tb::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--blue),var(--cyan),transparent)}
.logo{display:flex;align-items:center;gap:10px;flex-shrink:0}
.logo-ic{width:34px;height:34px;border-radius:7px;background:linear-gradient(135deg,var(--blue-d),var(--blue));display:flex;align-items:center;justify-content:center;font-size:15px;box-shadow:0 0 12px rgba(59,130,246,.4)}
.logo-nm{font-family:var(--disp);font-size:14px;font-weight:800;letter-spacing:-.02em}
.logo-sb{font-family:var(--mono);font-size:7px;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-top:1px}
.plan-pill{font-family:var(--mono);font-size:9px;font-weight:700;padding:4px 12px;border-radius:20px;letter-spacing:.06em;text-transform:uppercase;border:1px solid}
.plan-pill.gold{color:var(--gold);background:rgba(200,151,58,.1);border-color:rgba(200,151,58,.3)}
.plan-pill.blue{color:var(--blue);background:rgba(59,130,246,.1);border-color:rgba(59,130,246,.3)}
.plan-pill.cyan{color:var(--cyan);background:rgba(6,182,212,.1);border-color:rgba(6,182,212,.3)}
.tb-r{display:flex;align-items:center;gap:10px;flex-shrink:0}
.updated{font-family:var(--mono);font-size:8px;color:var(--muted)}
.ref-btn{font-family:var(--mono);font-size:8px;font-weight:700;color:#fff;background:var(--blue);border:none;border-radius:5px;padding:5px 11px;cursor:pointer;transition:background .15s}
.ref-btn:hover{background:var(--blue-d)}

/* COVERAGE BANNER */
.cov{position:relative;z-index:1;margin:20px 28px 0;background:rgba(15,23,42,.9);border:1px solid var(--border);border-radius:12px;padding:14px 20px;display:flex;align-items:flex-start;gap:14px}
.cov-ic{font-size:20px;flex-shrink:0;margin-top:2px}
.cov-tag{font-family:var(--mono);font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:3px}
.cov-val{font-family:var(--disp);font-size:14px;font-weight:800}
.cov-states{font-family:var(--mono);font-size:9px;color:#94a3b8;margin-top:3px;line-height:1.6}

/* STATS */
.stats{position:relative;z-index:1;display:flex;margin:14px 28px 0;background:rgba(15,23,42,.8);border:1px solid var(--border);border-radius:11px;overflow:hidden}
.sv{flex:1;padding:14px 10px;text-align:center;border-right:1px solid var(--border)}
.sv:last-child{border:none}
.sv-n{font-family:var(--disp);font-size:20px;font-weight:800}
.sv-n.r{color:var(--red)}.sv-n.y{color:var(--yellow)}.sv-n.b{color:var(--blue)}.sv-n.g{color:var(--green)}
.sv-l{font-family:var(--mono);font-size:7px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-top:3px}

/* CONTROLS */
.controls{position:relative;z-index:1;display:flex;align-items:center;gap:9px;padding:14px 28px;flex-wrap:wrap}
.sw{flex:1;min-width:180px;position:relative}
.sw input{width:100%;background:rgba(15,23,42,.9);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--body);font-size:12px;padding:8px 13px 8px 33px;outline:none;transition:border-color .15s}
.sw input:focus{border-color:var(--blue)}
.sw input::placeholder{color:var(--muted)}
.sw-ic{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:13px;pointer-events:none}
.pills{display:flex;gap:5px;flex-wrap:wrap}
.pill{font-family:var(--mono);font-size:8px;font-weight:700;padding:5px 11px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;letter-spacing:.06em;text-transform:uppercase;transition:all .15s}
.pill:hover{border-color:var(--blue);color:var(--blue)}
.pill.on{background:rgba(59,130,246,.12);border-color:var(--blue);color:var(--blue)}
.pill.hp.on{background:rgba(239,68,68,.12);border-color:var(--red);color:var(--red)}
.pill.wp.on{background:rgba(245,158,11,.12);border-color:var(--yellow);color:var(--yellow)}
.sort-sel{background:rgba(15,23,42,.9);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:var(--mono);font-size:9px;padding:7px 9px;outline:none;cursor:pointer}
.sort-sel option{background:#0f172a}

/* GRID */
.main{position:relative;z-index:1;padding:0 28px 60px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;padding-top:14px}
.empty{grid-column:1/-1;text-align:center;padding:60px;font-family:var(--mono);font-size:12px;color:var(--muted)}
.loading{text-align:center;padding:80px 20px}
.spinner{width:34px;height:34px;border:3px solid rgba(59,130,246,.2);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 14px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading p{font-family:var(--mono);font-size:10px;color:var(--muted)}

/* CARDS */
.card{background:rgba(15,23,42,.92);border:1px solid var(--border);border-radius:13px;overflow:hidden;transition:transform .18s,box-shadow .18s;cursor:pointer}
.card:hover{transform:translateY(-4px);box-shadow:0 16px 40px rgba(0,0,0,.4)}
.cs{height:3px}
.cs.hot{background:linear-gradient(90deg,var(--red),#f97316);box-shadow:0 0 10px rgba(239,68,68,.5)}
.cs.warm{background:linear-gradient(90deg,var(--yellow),#f97316);box-shadow:0 0 10px rgba(245,158,11,.4)}
.cs.cool{background:linear-gradient(90deg,var(--blue),var(--cyan))}
.cb{padding:16px 16px 10px}
.cr1{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:9px}
.cname{font-family:var(--disp);font-size:15px;font-weight:800;letter-spacing:-.02em}
.csub{font-family:var(--mono);font-size:8px;color:var(--muted);margin-top:2px;letter-spacing:.04em}
.ring-wrap{position:relative;flex-shrink:0}
.ring-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.ring-num{font-family:var(--disp);font-size:13px;font-weight:900;line-height:1}
.ring-lbl{font-family:var(--mono);font-size:7px;color:var(--muted)}
.cond{font-family:var(--mono);font-size:9px;color:var(--cyan);background:rgba(6,182,212,.08);border:1px solid rgba(6,182,212,.2);border-radius:4px;padding:3px 7px;display:inline-block;margin-bottom:7px;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ctier{font-family:var(--mono);font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:9px}
.ctier.hot{color:var(--red)}.ctier.warm{color:var(--yellow)}.ctier.cool{color:var(--blue)}
.igrid{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:9px}
.ic{background:rgba(2,6,23,.6);border:1px solid var(--border);border-radius:5px;padding:6px 8px;font-family:var(--mono);font-size:8px;color:var(--muted);letter-spacing:.04em}
.ic strong{display:block;font-size:10px;color:var(--text);font-weight:700;margin-top:2px;font-family:var(--body)}
.fchips{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:3px}
.fc{font-family:var(--mono);font-size:7px;padding:2px 6px;border-radius:3px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);color:#93c5fd}
.fc.warn{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.2);color:#fcd34d}
.cfoot{display:flex;gap:7px;padding:9px 16px 13px}
.cbtn{flex:1;padding:8px;border-radius:6px;font-family:var(--body);font-size:10px;font-weight:700;cursor:pointer;border:none;transition:all .15s}
.cbtn-p{background:linear-gradient(135deg,var(--blue-d),var(--blue));color:#fff}
.cbtn-p:hover{box-shadow:0 4px 14px rgba(59,130,246,.4)}
.cbtn-o{background:transparent;border:1px solid var(--border);color:var(--muted)}
.cbtn-o:hover{border-color:var(--blue);color:var(--blue)}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(2,6,23,.88);z-index:200;backdrop-filter:blur(8px);padding:20px;overflow-y:auto}
.overlay.show{display:flex;align-items:flex-start;justify-content:center}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:16px;max-width:620px;width:100%;position:relative;overflow:hidden;margin:auto}
.modal-top{height:3px;background:linear-gradient(90deg,var(--blue),var(--cyan))}
.mhd{padding:20px 22px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:14px}
.mhd-name{font-family:var(--disp);font-size:19px;font-weight:800;letter-spacing:-.02em}
.mhd-sub{font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:3px;letter-spacing:.04em}
.mclose{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);border-radius:5px;color:var(--red);font-size:13px;width:28px;height:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .15s}
.mclose:hover{background:rgba(239,68,68,.2)}
.mbody{padding:20px 22px}
.mscore{display:flex;align-items:center;gap:14px;background:rgba(2,6,23,.6);border:1px solid var(--border);border-radius:9px;padding:12px 16px;margin-bottom:16px}
.ms-n{font-family:var(--disp);font-size:40px;font-weight:900;line-height:1}
.ms-lbl{font-family:var(--mono);font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-top:2px}
.ms-badge{font-family:var(--mono);font-size:9px;font-weight:700;padding:3px 10px;border-radius:20px;text-transform:uppercase;letter-spacing:.06em}
.ms-badge.hot{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);color:var(--red)}
.ms-badge.warm{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.3);color:var(--yellow)}
.ms-badge.cool{background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.3);color:var(--blue)}
.msec{margin-bottom:14px}
.msec-t{font-family:var(--mono);font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:7px;padding-bottom:5px;border-bottom:1px solid var(--border)}
.mgrid{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.mcell{background:rgba(2,6,23,.5);border:1px solid var(--border);border-radius:7px;padding:9px 12px}
.mcell-l{font-family:var(--mono);font-size:8px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase}
.mcell-v{font-size:12px;font-weight:700;color:var(--text);margin-top:3px}
.contact-block{background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.2);border-radius:9px;padding:13px 16px}
.contact-t{font-family:var(--mono);font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--green);margin-bottom:9px}
.crow{display:flex;align-items:center;gap:9px;margin-bottom:6px;font-size:12px}
.crow:last-child{margin:0}
.c-lbl{font-family:var(--mono);font-size:8px;color:var(--muted);width:40px;flex-shrink:0}
.c-val{color:var(--text);font-weight:600}
.c-val a{color:var(--blue);text-decoration:none}
.c-val a:hover{text-decoration:underline}
.mflags{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px}
.mfoot{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:9px}
.mfbtn{flex:1;padding:10px;border-radius:7px;font-family:var(--body);font-size:11px;font-weight:700;cursor:pointer;border:none;transition:all .15s}
.mfbtn-p{background:linear-gradient(135deg,var(--blue-d),var(--blue));color:#fff}
.mfbtn-o{background:transparent;border:1px solid var(--border);color:var(--muted)}
.mfbtn-o:hover{border-color:var(--blue);color:var(--blue)}

/* NO PLAN SCREEN */
.noplan{position:relative;z-index:1;max-width:480px;margin:80px auto;text-align:center;padding:0 28px}
.noplan-ic{font-size:44px;margin-bottom:18px}
.noplan h2{font-family:var(--disp);font-size:24px;font-weight:800;margin-bottom:10px}
.noplan p{font-size:13px;color:#94a3b8;line-height:1.7;margin-bottom:22px}
.noplan a{display:inline-block;padding:11px 22px;border-radius:7px;background:linear-gradient(135deg,var(--blue-d),var(--blue));color:#fff;font-family:var(--body);font-size:12px;font-weight:700;text-decoration:none}

@media(max-width:640px){.tb,.cov,.stats,.controls,.main{padding-left:14px;padding-right:14px}.stats{flex-wrap:wrap}.sv{min-width:50%;border-bottom:1px solid var(--border)}.mgrid{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="tb">
  <div class="logo">
    <div class="logo-ic">‚öñ</div>
    <div><div class="logo-nm">StayVCS</div><div class="logo-sb">Attorney Lead Portal</div></div>
  </div>
  <div class="tb-r">
    <div class="plan-pill" id="planPill">Loading...</div>
    <div class="updated" id="updated">Loading...</div>
    <button class="ref-btn" onclick="loadLeads()">‚Üª Refresh</button>
  </div>
</div>

<div class="cov" id="covBanner">
  <div class="cov-ic" id="covIc">üìç</div>
  <div>
    <div class="cov-tag">Your Coverage Area</div>
    <div class="cov-val" id="covVal">Loading...</div>
    <div class="cov-states" id="covStates"></div>
  </div>
</div>

<div class="stats">
  <div class="sv"><div class="sv-n b" id="stTotal">‚Äî</div><div class="sv-l">Your Leads</div></div>
  <div class="sv"><div class="sv-n r" id="stHot">‚Äî</div><div class="sv-l">Grade-A Hot</div></div>
  <div class="sv"><div class="sv-n y" id="stWarm">‚Äî</div><div class="sv-l">Grade-B Warm</div></div>
  <div class="sv"><div class="sv-n g" id="stAvg">‚Äî</div><div class="sv-l">Avg Score</div></div>
  <div class="sv"><div class="sv-n b" id="stTop">‚Äî</div><div class="sv-l">Top Score</div></div>
</div>

<div class="controls">
  <div class="sw">
    <span class="sw-ic">üîç</span>
    <input type="text" id="searchBox" placeholder="Search name, condition, state..." oninput="render()">
  </div>
  <div class="pills">
    <button class="pill on" onclick="setFilter(this,'all')">All</button>
    <button class="pill hp" onclick="setFilter(this,'hot')">üî¥ Hot</button>
    <button class="pill wp" onclick="setFilter(this,'warm')">üü° Warm</button>
    <button class="pill" onclick="setFilter(this,'cool')">üîµ Low</button>
  </div>
  <select class="sort-sel" id="sortSel" onchange="render()">
    <option value="score">Score ‚Üì</option>
    <option value="name">Name</option>
    <option value="state">State</option>
  </select>
</div>

<div class="main"><div id="mainContent"><div class="loading"><div class="spinner"></div><p>Loading your leads...</p></div></div></div>

<!-- MODAL -->
<div class="overlay" id="overlay" onclick="closeOverlay(event)">
  <div class="modal">
    <div class="modal-top"></div>
    <div class="mhd">
      <div><div class="mhd-name" id="mName"></div><div class="mhd-sub" id="mSub"></div></div>
      <button class="mclose" onclick="document.getElementById('overlay').classList.remove('show')">‚úï</button>
    </div>
    <div class="mbody" id="mBody"></div>
    <div class="mfoot">
      <button class="mfbtn mfbtn-p" id="mCall">üìû Call Lead</button>
      <button class="mfbtn mfbtn-o" onclick="copyModal()">üìã Copy Details</button>
      <button class="mfbtn mfbtn-o" onclick="document.getElementById('overlay').classList.remove('show')">Close</button>
    </div>
  </div>
</div>

<script>
var API = 'https://script.google.com/macros/s/AKfycbxI9gWvKnXt7E66K144fY44HfXEGYfgnm8vjFXn1VB5zOASAbcOgzk4dKiRub9BDo4/exec';

// Read URL params
var P       = new URLSearchParams(window.location.search);
var PLAN    = P.get('plan')   || '';
var TIER    = parseInt(P.get('tier')||'0',10);
var RAW     = P.get('states') || '';
var FIRM    = P.get('firm')   || 'Your Firm';

// Build states filter array
var STATE_FILTER = [];  // empty = show all (national)
if(RAW && RAW!=='ALL' && TIER!==3){
  STATE_FILTER = RAW.split('|').map(function(s){return s.trim();}).filter(Boolean);
}

// Set plan pill color
var PCOLOR = TIER===1?'gold':TIER===2?'blue':'cyan';

// Setup UI
(function init(){
  var pill = document.getElementById('planPill');
  pill.textContent = PLAN||'Attorney Portal';
  pill.className = 'plan-pill '+PCOLOR;

  if(TIER===1){
    document.getElementById('covIc').textContent='üìç';
    document.getElementById('covVal').textContent = STATE_FILTER[0]||'1 State';
    document.getElementById('covStates').textContent='State Access ‚Äî priority routing for 1 state';
  } else if(TIER===2){
    document.getElementById('covIc').textContent='üó∫';
    document.getElementById('covVal').textContent='Regional Coverage ‚Äî '+STATE_FILTER.length+' states';
    document.getElementById('covStates').textContent=STATE_FILTER.join(' ¬∑ ');
  } else {
    document.getElementById('covIc').textContent='üåé';
    document.getElementById('covVal').textContent='National Access ‚Äî All 53 Locations';
    document.getElementById('covStates').textContent='All 50 states + Washington DC + Puerto Rico + Virgin Islands';
  }
})();

// Data
var ALL=[], curFilter='all', curLead=null;

function filterByPlan(leads){
  if(!STATE_FILTER.length) return leads;  // national = all
  return leads.filter(function(l){ return STATE_FILTER.indexOf(l.state)!==-1; });
}

async function loadLeads(){
  document.getElementById('mainContent').innerHTML='<div class="loading"><div class="spinner"></div><p>Fetching leads from Google Sheets...</p></div>';
  document.getElementById('updated').textContent='Refreshing...';
  try{
    var r=await fetch(API);
    var j=await r.json();
    if(!j.success) throw new Error('no success');
    ALL=filterByPlan(j.leads||[]);
    var t=new Date(j.updatedAt);
    document.getElementById('updated').textContent='Updated '+t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  }catch(e){
    ALL=filterByPlan(getSample());
    document.getElementById('updated').textContent='Sample data';
  }
  updateStats(); render();
}

function updateStats(){
  var hot=ALL.filter(function(l){return tier(l.tier)==='hot';}).length;
  var warm=ALL.filter(function(l){return tier(l.tier)==='warm';}).length;
  var avg=ALL.length?Math.round(ALL.reduce(function(a,l){return a+l.score;},0)/ALL.length):0;
  var top=ALL.length?Math.max.apply(null,ALL.map(function(l){return l.score;})):0;
  document.getElementById('stTotal').textContent=ALL.length;
  document.getElementById('stHot').textContent=hot;
  document.getElementById('stWarm').textContent=warm;
  document.getElementById('stAvg').textContent=avg;
  document.getElementById('stTop').textContent=top;
}

function tier(t){
  if(!t) return 'cool';
  t=t.toLowerCase();
  if(t.includes('hot')) return 'hot';
  if(t.includes('warm')) return 'warm';
  return 'cool';
}

function setFilter(btn,f){
  document.querySelectorAll('.pill').forEach(function(b){b.classList.remove('on');});
  btn.classList.add('on'); curFilter=f; render();
}

function getFiltered(){
  var q=document.getElementById('searchBox').value.toLowerCase().trim();
  var f=ALL.filter(function(l){
    var mf=curFilter==='all'||tier(l.tier)===curFilter;
    var ms=!q||[l.name||'',l.condition||'',l.state||''].join(' ').toLowerCase().includes(q);
    return mf&&ms;
  });
  var s=document.getElementById('sortSel').value;
  f.sort(function(a,b){
    if(s==='score') return b.score-a.score;
    if(s==='name')  return (a.name||'').localeCompare(b.name||'');
    if(s==='state') return (a.state||'').localeCompare(b.state||'');
    return 0;
  });
  return f;
}

function render(){
  var leads=getFiltered();
  var main=document.getElementById('mainContent');
  if(!leads.length){main.innerHTML='<div class="grid"><div class="empty">No leads match this filter in your coverage area.</div></div>';return;}
  main.innerHTML='<div class="grid">'+leads.map(cardHTML).join('')+'</div>';
}

// Score ring
function sc(s){return s>=85?'var(--red)':s>=70?'var(--yellow)':s>=50?'var(--blue)':'var(--muted)';}
function sg(s){return s>=85?'rgba(239,68,68,.5)':s>=70?'rgba(245,158,11,.4)':s>=50?'rgba(59,130,246,.35)':'transparent';}
function ring(score){
  var col=sc(score),r=21,cx=27,ci=2*Math.PI*r,d=ci*(score/100);
  return '<div class="ring-wrap"><svg width="54" height="54" viewBox="0 0 54 54"><circle cx="'+cx+'" cy="'+cx+'" r="'+r+'" fill="none" stroke="rgba(51,65,85,.6)" stroke-width="4"/><circle cx="'+cx+'" cy="'+cx+'" r="'+r+'" fill="none" stroke="'+col+'" stroke-width="4" stroke-dasharray="'+ci+'" stroke-dashoffset="'+(ci-d)+'" stroke-linecap="round" filter="drop-shadow(0 0 4px '+sg(score)+')"/></svg><div class="ring-inner"><div class="ring-num" style="color:'+col+'">'+score+'</div><div class="ring-lbl">/ 100</div></div></div>';
}

function cardHTML(l){
  var t=tier(l.tier),lbl=t==='hot'?'Hot Lead':t==='warm'?'Warm Lead':'Low Priority';
  var flags=[].concat(l.flags||[],(l.warnings||[]).map(function(w){return '‚ö† '+w;}));
  var chips=flags.slice(0,3).map(function(f){var w=f.includes('‚ö†');return '<span class="fc'+(w?' warn':'')+'">'+f.replace('‚ö†','').replace('‚úì','').trim().slice(0,24)+'</span>';}).join('')+(flags.length>3?'<span class="fc">+'+(flags.length-3)+' more</span>':'');
  return '<div class="card" onclick="openModal(\''+l.id+'\')"><div class="cs '+t+'"></div><div class="cb"><div class="cr1"><div><div class="cname">'+(l.name||'Unknown')+'</div><div class="csub">'+(l.id||'')+' &middot; '+(l.state||'‚Äî')+'</div></div>'+ring(l.score)+'</div><div class="cond">'+(l.condition||'Condition not specified')+'</div><div class="ctier '+t+'">'+lbl+' &nbsp;&middot;&nbsp; Grade '+(l.grade||'‚Äî')+'</div><div class="igrid"><div class="ic">Age<strong>'+(l.age||'‚Äî')+'</strong></div><div class="ic">Work<strong>'+sw(l.workStatus)+'</strong></div><div class="ic">Prior Claim<strong>'+(l.priorClaim||'‚Äî')+'</strong></div><div class="ic">Denial<strong>'+(l.hasDenial||'‚Äî')+'</strong></div></div>'+(chips?'<div class="fchips">'+chips+'</div>':'')+'</div><div class="cfoot"><button class="cbtn cbtn-p" onclick="event.stopPropagation();openModal(\''+l.id+'\')">View Profile</button><button class="cbtn cbtn-o" onclick="event.stopPropagation();copyCard(\''+l.id+'\')">Copy</button></div></div>';
}

function sw(w){if(!w)return '‚Äî';w=w.toLowerCase();if(w.includes('unemployed')||w.includes('not working'))return 'Not Working';if(w.includes('self'))return 'Self-Emp.';if(w.includes('part'))return 'Part-Time';if(w.includes('full'))return 'Full-Time';return w.slice(0,12);}

// Modal
function openModal(id){
  curLead=ALL.find(function(l){return l.id===id;});
  if(!curLead) return;
  var l=curLead,col=sc(l.score),t=tier(l.tier),lbl=t==='hot'?'Hot Lead':t==='warm'?'Warm Lead':'Low Priority';
  document.getElementById('mName').textContent=l.name||'Unknown';
  document.getElementById('mSub').textContent=(l.id||'')+' ¬∑ '+(l.state||'')+(l.timestamp?' ¬∑ '+new Date(l.timestamp).toLocaleDateString():'');
  var cb=document.getElementById('mCall');
  if(l.phone){cb.textContent='üìû Call '+l.phone;cb.onclick=function(){window.location.href='tel:'+l.phone.replace(/\D/g,'');};}
  else{cb.textContent='üìû No Phone on File';cb.onclick=null;}
  var flags=[].concat(l.flags||[],(l.warnings||[]).map(function(w){return '‚ö† '+w;}));
  var fchips=flags.map(function(f){var w=f.includes('‚ö†');return '<span class="fc'+(w?' warn':'')+'">'+f.replace('‚ö†','').replace('‚úì','').trim()+'</span>';}).join('');
  document.getElementById('mBody').innerHTML=
    '<div class="mscore"><div><div class="ms-n" style="color:'+col+'">'+l.score+'</div><div class="ms-lbl">SSA Qualifier Score</div></div><div><div class="ms-badge '+t+'">'+lbl+'</div><div style="font-family:var(--mono);font-size:9px;color:var(--muted);margin-top:5px">Grade '+(l.grade||'‚Äî')+'</div></div></div>'
    +'<div class="msec"><div class="msec-t">Claimant Profile</div><div class="mgrid">'+mc('Condition',l.condition)+mc('State',l.state)+mc('Age',l.age)+mc('Work Status',sw(l.workStatus))+mc('Over SGA',l.overSGA)+mc('Prior Claim',l.priorClaim)+mc('Denial Letter',l.hasDenial)+mc('Sit Tolerance',l.sitTime)+mc('Stand Tolerance',l.standTime)+mc('Lift Capacity',l.liftWeight)+'</div></div>'
    +(l.impact?'<div class="msec"><div class="msec-t">Impact Statement</div><div style="font-size:12px;color:#94a3b8;line-height:1.7;background:rgba(2,6,23,.5);border:1px solid var(--border);border-radius:7px;padding:11px 13px">'+l.impact+'</div></div>':'')
    +'<div class="msec"><div class="msec-t">Contact Information</div><div class="contact-block"><div class="contact-t">Ready to Contact</div>'+cr('Phone',l.phone?'<a href="tel:'+l.phone.replace(/\D/g,'')+'">'+l.phone+'</a>':'‚Äî')+cr('Email',l.email?'<a href="mailto:'+l.email+'">'+l.email+'</a>':'‚Äî')+'</div></div>'
    +(fchips?'<div class="msec"><div class="msec-t">Qualification Factors</div><div class="mflags">'+fchips+'</div></div>':'');
  document.getElementById('overlay').classList.add('show');
}

function mc(l,v){return '<div class="mcell"><div class="mcell-l">'+l+'</div><div class="mcell-v">'+(v||'‚Äî')+'</div></div>';}
function cr(l,v){return '<div class="crow"><span class="c-lbl">'+l+'</span><span class="c-val">'+v+'</span></div>';}

function closeOverlay(e){if(e.target===document.getElementById('overlay'))document.getElementById('overlay').classList.remove('show');}

function copyCard(id){
  var l=ALL.find(function(x){return x.id===id;});
  if(!l) return;
  navigator.clipboard.writeText([l.name,l.state,'Score: '+l.score,'Grade: '+l.grade,l.condition,'Phone: '+(l.phone||'‚Äî'),'Email: '+(l.email||'‚Äî')].join('\n')).catch(function(){});
}

function copyModal(){
  if(!curLead) return;
  var l=curLead;
  navigator.clipboard.writeText(['STAYVCS LEAD PROFILE','--------------------','ID: '+l.id,'Name: '+(l.name||'‚Äî'),'State: '+(l.state||'‚Äî'),'Score: '+l.score+' / 100','Grade: '+(l.grade||'‚Äî'),'Tier: '+(l.tier||'‚Äî'),'Condition: '+(l.condition||'‚Äî'),'Age: '+(l.age||'‚Äî'),'Work Status: '+(l.workStatus||'‚Äî'),'Phone: '+(l.phone||'‚Äî'),'Email: '+(l.email||'‚Äî'),'Prior Claim: '+(l.priorClaim||'‚Äî'),'Denial Letter: '+(l.hasDenial||'‚Äî')].join('\n')).catch(function(){});
}

// Sample data for offline / demo
function getSample(){
  var pool=['Tennessee','Mississippi','Georgia','Alabama','Texas','Florida','Ohio','Pennsylvania','California','New York','Illinois','Michigan'];
  var useSt=STATE_FILTER.length?STATE_FILTER:pool;
  function rs(){return useSt[Math.floor(Math.random()*useSt.length)];}
  return [
    {id:'DIS-001',name:'James R. Morrison',state:rs(),age:54,score:93,grade:'A',tier:'Hot Lead ‚Äî Grade A',condition:'Degenerative Disc Disease',workStatus:'Not Working',overSGA:'No',priorClaim:'Yes',hasDenial:'Yes',sitTime:'10 min',standTime:'10 min',liftWeight:'< 10 lbs',phone:'(615) 555-0101',email:'jmorrison@email.com',impact:'Unable to sit or stand for extended periods due to severe lower back pain following spinal surgery.',flags:['‚úì Prior Claim','‚úì Denial Letter','‚úì RFC Supported'],warnings:[]},
    {id:'DIS-002',name:'Patricia L. Williams',state:rs(),age:49,score:86,grade:'A',tier:'Hot Lead ‚Äî Grade A',condition:'PTSD / Anxiety Disorder',workStatus:'Not Working',overSGA:'No',priorClaim:'Yes',hasDenial:'Yes',sitTime:'20 min',standTime:'20 min',liftWeight:'< 10 lbs',phone:'(601) 555-0202',email:'pwilliams@email.com',impact:'Severe PTSD episodes prevent maintaining consistent employment.',flags:['‚úì Prior Claim','‚úì Denial Letter'],warnings:[]},
    {id:'DIS-003',name:'Robert T. Jackson',state:rs(),age:61,score:79,grade:'B',tier:'Warm Lead ‚Äî Grade B',condition:'Congestive Heart Failure',workStatus:'Part-Time',overSGA:'No',priorClaim:'No',hasDenial:'No',sitTime:'30 min',standTime:'20 min',liftWeight:'10-20 lbs',phone:'(404) 555-0303',email:'rjackson@email.com',impact:'Shortness of breath limits all physical activity.',flags:['‚úì Medical Documentation'],warnings:['No prior claim on record']},
    {id:'DIS-004',name:'Sandra M. Davis',state:rs(),age:52,score:88,grade:'A',tier:'Hot Lead ‚Äî Grade A',condition:'Multiple Sclerosis',workStatus:'Not Working',overSGA:'No',priorClaim:'Yes',hasDenial:'Yes',sitTime:'15 min',standTime:'10 min',liftWeight:'< 10 lbs',phone:'(615) 555-0404',email:'sdavis@email.com',impact:'MS exacerbations cause unpredictable loss of motor function.',flags:['‚úì Prior Claim','‚úì Denial Letter','‚úì RFC Supported'],warnings:[]},
    {id:'DIS-005',name:'Michael A. Thompson',state:rs(),age:47,score:71,grade:'B',tier:'Warm Lead ‚Äî Grade B',condition:'Chronic Kidney Disease',workStatus:'Not Working',overSGA:'No',priorClaim:'Yes',hasDenial:'No',sitTime:'45 min',standTime:'30 min',liftWeight:'10-20 lbs',phone:'(901) 555-0505',email:'mthompson@email.com',impact:'Dialysis three times weekly severely limits work availability.',flags:['‚úì Prior Claim'],warnings:['No denial letter yet']},
    {id:'DIS-006',name:'Dorothy K. Henderson',state:rs(),age:58,score:91,grade:'A',tier:'Hot Lead ‚Äî Grade A',condition:'Fibromyalgia / Chronic Pain',workStatus:'Not Working',overSGA:'No',priorClaim:'Yes',hasDenial:'Yes',sitTime:'10 min',standTime:'10 min',liftWeight:'< 10 lbs',phone:'(615) 555-0606',email:'dhenderson@email.com',impact:'Widespread chronic pain prevents any sustained work activity.',flags:['‚úì Prior Claim','‚úì Denial Letter','‚úì RFC Supported','‚úì Age Factor'],warnings:[]},
    {id:'DIS-007',name:'Charles B. Washington',state:rs(),age:56,score:84,grade:'A',tier:'Hot Lead ‚Äî Grade A',condition:'Spinal Stenosis',workStatus:'Not Working',overSGA:'No',priorClaim:'Yes',hasDenial:'Yes',sitTime:'15 min',standTime:'15 min',liftWeight:'< 10 lbs',phone:'(713) 555-0707',email:'cwashington@email.com',impact:'Severe spinal stenosis causes radiating pain into both legs.',flags:['‚úì Prior Claim','‚úì Denial Letter'],warnings:[]},
    {id:'DIS-008',name:'Angela T. Robinson',state:rs(),age:44,score:67,grade:'B',tier:'Warm Lead ‚Äî Grade B',condition:'Bipolar Disorder',workStatus:'Part-Time',overSGA:'No',priorClaim:'Yes',hasDenial:'No',sitTime:'60 min',standTime:'45 min',liftWeight:'20-30 lbs',phone:'(312) 555-0808',email:'arobinson@email.com',impact:'Manic and depressive episodes make consistent work impossible.',flags:['‚úì Prior Claim'],warnings:['Partial work history']}
  ];
}

loadLeads();
</script>
</body>
</html>
