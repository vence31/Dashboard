<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxI9gWvKnXt7E66K144fY44HfXEGYfgnm8vjFXn1VB5zOASAbcOgzk4dKiRub9BDo4/exec";
let allLeads=[], curFilter="all";

async function loadLeads() {
  const urlParams = new URLSearchParams(window.location.search);
  const refId = urlParams.get('refId');

  if (!refId) {
    document.getElementById("mainContent").innerHTML = `
      <div class="error-box">
        <strong>Security Authentication Required</strong>
        No Partner Reference ID detected. Please use the secure link provided in your onboarding email.
      </div>`;
    return;
  }

  document.getElementById("mainContent").innerHTML=`<div class="loading"><div class="spinner"></div><p>Verifying Partner Credentials...</p></div>`;
  
  try {
    // 1. Get Attorney Coverage first
    const covRes = await fetch(APPS_SCRIPT_URL + "?action=get_attorney_coverage&refId=" + refId);
    const coverage = await covRes.json();
    
    if (!coverage.success) {
      document.getElementById("mainContent").innerHTML = `<div class="error-box"><strong>Access Denied</strong> ${coverage.error}</div>`;
      return;
    }

    // 2. Load all leads
    const res = await fetch(APPS_SCRIPT_URL);
    const json = await res.json();
    
    // 3. Filter leads based on coverage
    let filtered = json.leads || [];
    if (coverage.states !== "ALL 53 STATES") {
      const allowedList = coverage.states.split(", ").map(s => s.toLowerCase().trim());
      filtered = filtered.filter(lead => allowedList.includes(lead.state.toLowerCase().trim()));
    }

    allLeads = filtered;
    updateStats(); 
    render();
    
    const t = new Date();
    document.getElementById("lastUpdated").textContent = "Partner: " + coverage.firmName + " | " + t.toLocaleTimeString();
    
  } catch(err) {
    document.getElementById("mainContent").innerHTML = `<div class="error-box"><strong>System Connection Error</strong> Unable to reach lead database.</div>`;
  }
}

// ... keep existing render, updateStats, and modal functions ...
</script>
